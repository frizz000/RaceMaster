<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>werkzeug.routing.map &#8212; RaceMaster 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for werkzeug.routing.map</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">posixpath</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span>

<span class="kn">from</span> <span class="nn">.._internal</span> <span class="kn">import</span> <span class="n">_encode_idna</span>
<span class="kn">from</span> <span class="nn">.._internal</span> <span class="kn">import</span> <span class="n">_get_environ</span>
<span class="kn">from</span> <span class="nn">.._internal</span> <span class="kn">import</span> <span class="n">_to_str</span>
<span class="kn">from</span> <span class="nn">.._internal</span> <span class="kn">import</span> <span class="n">_wsgi_decoding_dance</span>
<span class="kn">from</span> <span class="nn">..datastructures</span> <span class="kn">import</span> <span class="n">ImmutableDict</span>
<span class="kn">from</span> <span class="nn">..datastructures</span> <span class="kn">import</span> <span class="n">MultiDict</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">BadHost</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">MethodNotAllowed</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">NotFound</span>
<span class="kn">from</span> <span class="nn">..urls</span> <span class="kn">import</span> <span class="n">url_encode</span>
<span class="kn">from</span> <span class="nn">..urls</span> <span class="kn">import</span> <span class="n">url_join</span>
<span class="kn">from</span> <span class="nn">..urls</span> <span class="kn">import</span> <span class="n">url_quote</span>
<span class="kn">from</span> <span class="nn">..wsgi</span> <span class="kn">import</span> <span class="n">get_host</span>
<span class="kn">from</span> <span class="nn">.converters</span> <span class="kn">import</span> <span class="n">DEFAULT_CONVERTERS</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">BuildError</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">NoMatch</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">RequestAliasRedirect</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">RequestPath</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">RequestRedirect</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">WebsocketMismatch</span>
<span class="kn">from</span> <span class="nn">.matcher</span> <span class="kn">import</span> <span class="n">StateMachineMatcher</span>
<span class="kn">from</span> <span class="nn">.rules</span> <span class="kn">import</span> <span class="n">_simple_rule_re</span>
<span class="kn">from</span> <span class="nn">.rules</span> <span class="kn">import</span> <span class="n">Rule</span>

<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">typing_extensions</span> <span class="k">as</span> <span class="nn">te</span>
    <span class="kn">from</span> <span class="nn">_typeshed.wsgi</span> <span class="kn">import</span> <span class="n">WSGIApplication</span>
    <span class="kn">from</span> <span class="nn">_typeshed.wsgi</span> <span class="kn">import</span> <span class="n">WSGIEnvironment</span>
    <span class="kn">from</span> <span class="nn">.converters</span> <span class="kn">import</span> <span class="n">BaseConverter</span>
    <span class="kn">from</span> <span class="nn">.rules</span> <span class="kn">import</span> <span class="n">RuleFactory</span>
    <span class="kn">from</span> <span class="nn">..wrappers.request</span> <span class="kn">import</span> <span class="n">Request</span>


<span class="k">class</span> <span class="nc">Map</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The map class stores all the URL rules and some configuration</span>
<span class="sd">    parameters.  Some of the configuration values are only stored on the</span>
<span class="sd">    `Map` instance since those affect all rules, others are just defaults</span>
<span class="sd">    and can be overridden for each rule.  Note that you have to specify all</span>
<span class="sd">    arguments besides the `rules` as keyword arguments!</span>

<span class="sd">    :param rules: sequence of url rules for this map.</span>
<span class="sd">    :param default_subdomain: The default subdomain for rules without a</span>
<span class="sd">                              subdomain defined.</span>
<span class="sd">    :param charset: charset of the url. defaults to ``&quot;utf-8&quot;``</span>
<span class="sd">    :param strict_slashes: If a rule ends with a slash but the matched</span>
<span class="sd">        URL does not, redirect to the URL with a trailing slash.</span>
<span class="sd">    :param merge_slashes: Merge consecutive slashes when matching or</span>
<span class="sd">        building URLs. Matches will redirect to the normalized URL.</span>
<span class="sd">        Slashes in variable parts are not merged.</span>
<span class="sd">    :param redirect_defaults: This will redirect to the default rule if it</span>
<span class="sd">                              wasn&#39;t visited that way. This helps creating</span>
<span class="sd">                              unique URLs.</span>
<span class="sd">    :param converters: A dict of converters that adds additional converters</span>
<span class="sd">                       to the list of converters. If you redefine one</span>
<span class="sd">                       converter this will override the original one.</span>
<span class="sd">    :param sort_parameters: If set to `True` the url parameters are sorted.</span>
<span class="sd">                            See `url_encode` for more details.</span>
<span class="sd">    :param sort_key: The sort key function for `url_encode`.</span>
<span class="sd">    :param encoding_errors: the error method to use for decoding</span>
<span class="sd">    :param host_matching: if set to `True` it enables the host matching</span>
<span class="sd">                          feature and disables the subdomain one.  If</span>
<span class="sd">                          enabled the `host` parameter to rules is used</span>
<span class="sd">                          instead of the `subdomain` one.</span>

<span class="sd">    .. versionchanged:: 1.0</span>
<span class="sd">        If ``url_scheme`` is ``ws`` or ``wss``, only WebSocket rules</span>
<span class="sd">        will match.</span>

<span class="sd">    .. versionchanged:: 1.0</span>
<span class="sd">        Added ``merge_slashes``.</span>

<span class="sd">    .. versionchanged:: 0.7</span>
<span class="sd">        Added ``encoding_errors`` and ``host_matching``.</span>

<span class="sd">    .. versionchanged:: 0.5</span>
<span class="sd">        Added ``sort_parameters`` and ``sort_key``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: A dict of default converters to be used.</span>
    <span class="n">default_converters</span> <span class="o">=</span> <span class="n">ImmutableDict</span><span class="p">(</span><span class="n">DEFAULT_CONVERTERS</span><span class="p">)</span>

    <span class="c1">#: The type of lock to use when updating.</span>
    <span class="c1">#:</span>
    <span class="c1">#: .. versionadded:: 1.0</span>
    <span class="n">lock_class</span> <span class="o">=</span> <span class="n">Lock</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rules</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="s2">&quot;RuleFactory&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_subdomain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">charset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">strict_slashes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">merge_slashes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">redirect_defaults</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">converters</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;BaseConverter&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sort_parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sort_key</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">encoding_errors</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span>
        <span class="n">host_matching</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_matcher</span> <span class="o">=</span> <span class="n">StateMachineMatcher</span><span class="p">(</span><span class="n">merge_slashes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">Rule</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remap_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_class</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_subdomain</span> <span class="o">=</span> <span class="n">default_subdomain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding_errors</span> <span class="o">=</span> <span class="n">encoding_errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict_slashes</span> <span class="o">=</span> <span class="n">strict_slashes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_slashes</span> <span class="o">=</span> <span class="n">merge_slashes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect_defaults</span> <span class="o">=</span> <span class="n">redirect_defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_matching</span> <span class="o">=</span> <span class="n">host_matching</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_converters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">converters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">converters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sort_parameters</span> <span class="o">=</span> <span class="n">sort_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_key</span> <span class="o">=</span> <span class="n">sort_key</span>

        <span class="k">for</span> <span class="n">rulefactory</span> <span class="ow">in</span> <span class="n">rules</span> <span class="ow">or</span> <span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rulefactory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_endpoint_expecting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">arguments</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all rules and check if the endpoint expects</span>
<span class="sd">        the arguments provided.  This is for example useful if you have</span>
<span class="sd">        some URLs that expect a language code and others that do not and</span>
<span class="sd">        you want to wrap the builder a bit so that the current language</span>
<span class="sd">        code is automatically added if not provided but endpoints expect</span>
<span class="sd">        it.</span>

<span class="sd">        :param endpoint: the endpoint to check.</span>
<span class="sd">        :param arguments: this function accepts one or more arguments</span>
<span class="sd">                          as positional arguments.  Each one of them is</span>
<span class="sd">                          checked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="p">[</span><span class="n">endpoint</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">arguments</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">Rule</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">rule</span> <span class="k">for</span> <span class="n">rules</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">iter_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="n">Rule</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all rules or the rules of an endpoint.</span>

<span class="sd">        :param endpoint: if provided only the rules for that endpoint</span>
<span class="sd">                         are returned.</span>
<span class="sd">        :return: an iterator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="p">[</span><span class="n">endpoint</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rulefactory</span><span class="p">:</span> <span class="s2">&quot;RuleFactory&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new rule or factory to the map and bind it.  Requires that the</span>
<span class="sd">        rule is not bound to another map.</span>

<span class="sd">        :param rulefactory: a :class:`Rule` or :class:`RuleFactory`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rulefactory</span><span class="o">.</span><span class="n">get_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rule</span><span class="o">.</span><span class="n">build_only</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_matcher</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">script_name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">subdomain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">url_scheme</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span><span class="p">,</span>
        <span class="n">default_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="n">path_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MapAdapter&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new :class:`MapAdapter` with the details specified to the</span>
<span class="sd">        call.  Note that `script_name` will default to ``&#39;/&#39;`` if not further</span>
<span class="sd">        specified or `None`.  The `server_name` at least is a requirement</span>
<span class="sd">        because the HTTP RFC requires absolute URLs for redirects and so all</span>
<span class="sd">        redirect exceptions raised by Werkzeug will contain the full canonical</span>
<span class="sd">        URL.</span>

<span class="sd">        If no path_info is passed to :meth:`match` it will use the default path</span>
<span class="sd">        info passed to bind.  While this doesn&#39;t really make sense for</span>
<span class="sd">        manual bind calls, it&#39;s useful if you bind a map to a WSGI</span>
<span class="sd">        environment which already contains the path info.</span>

<span class="sd">        `subdomain` will default to the `default_subdomain` for this map if</span>
<span class="sd">        no defined. If there is no `default_subdomain` you cannot use the</span>
<span class="sd">        subdomain feature.</span>

<span class="sd">        .. versionchanged:: 1.0</span>
<span class="sd">            If ``url_scheme`` is ``ws`` or ``wss``, only WebSocket rules</span>
<span class="sd">            will match.</span>

<span class="sd">        .. versionchanged:: 0.15</span>
<span class="sd">            ``path_info`` defaults to ``&#39;/&#39;`` if ``None``.</span>

<span class="sd">        .. versionchanged:: 0.8</span>
<span class="sd">            ``query_args`` can be a string.</span>

<span class="sd">        .. versionchanged:: 0.7</span>
<span class="sd">            Added ``query_args``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server_name</span> <span class="o">=</span> <span class="n">server_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_matching</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subdomain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;host matching enabled and a subdomain was provided&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subdomain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subdomain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_subdomain</span>
        <span class="k">if</span> <span class="n">script_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">script_name</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
        <span class="k">if</span> <span class="n">path_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path_info</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_name</span> <span class="o">=</span> <span class="n">_encode_idna</span><span class="p">(</span><span class="n">server_name</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadHost</span><span class="p">()</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">return</span> <span class="n">MapAdapter</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">server_name</span><span class="p">,</span>
            <span class="n">script_name</span><span class="p">,</span>
            <span class="n">subdomain</span><span class="p">,</span>
            <span class="n">url_scheme</span><span class="p">,</span>
            <span class="n">path_info</span><span class="p">,</span>
            <span class="n">default_method</span><span class="p">,</span>
            <span class="n">query_args</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind_to_environ</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">environ</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s2">&quot;WSGIEnvironment&quot;</span><span class="p">,</span> <span class="s2">&quot;Request&quot;</span><span class="p">],</span>
        <span class="n">server_name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">subdomain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MapAdapter&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Like :meth:`bind` but you can pass it an WSGI environment and it</span>
<span class="sd">        will fetch the information from that dictionary.  Note that because of</span>
<span class="sd">        limitations in the protocol there is no way to get the current</span>
<span class="sd">        subdomain and real `server_name` from the environment.  If you don&#39;t</span>
<span class="sd">        provide it, Werkzeug will use `SERVER_NAME` and `SERVER_PORT` (or</span>
<span class="sd">        `HTTP_HOST` if provided) as used `server_name` with disabled subdomain</span>
<span class="sd">        feature.</span>

<span class="sd">        If `subdomain` is `None` but an environment and a server name is</span>
<span class="sd">        provided it will calculate the current subdomain automatically.</span>
<span class="sd">        Example: `server_name` is ``&#39;example.com&#39;`` and the `SERVER_NAME`</span>
<span class="sd">        in the wsgi `environ` is ``&#39;staging.dev.example.com&#39;`` the calculated</span>
<span class="sd">        subdomain will be ``&#39;staging.dev&#39;``.</span>

<span class="sd">        If the object passed as environ has an environ attribute, the value of</span>
<span class="sd">        this attribute is used instead.  This allows you to pass request</span>
<span class="sd">        objects.  Additionally `PATH_INFO` added as a default of the</span>
<span class="sd">        :class:`MapAdapter` so that you don&#39;t have to pass the path info to</span>
<span class="sd">        the match method.</span>

<span class="sd">        .. versionchanged:: 1.0.0</span>
<span class="sd">            If the passed server name specifies port 443, it will match</span>
<span class="sd">            if the incoming scheme is ``https`` without a port.</span>

<span class="sd">        .. versionchanged:: 1.0.0</span>
<span class="sd">            A warning is shown when the passed server name does not</span>
<span class="sd">            match the incoming WSGI server name.</span>

<span class="sd">        .. versionchanged:: 0.8</span>
<span class="sd">           This will no longer raise a ValueError when an unexpected server</span>
<span class="sd">           name was passed.</span>

<span class="sd">        .. versionchanged:: 0.5</span>
<span class="sd">            previously this method accepted a bogus `calculate_subdomain`</span>
<span class="sd">            parameter that did not have any effect.  It was removed because</span>
<span class="sd">            of that.</span>

<span class="sd">        :param environ: a WSGI environment.</span>
<span class="sd">        :param server_name: an optional server name hint (see above).</span>
<span class="sd">        :param subdomain: optionally the current subdomain (see above).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">_get_environ</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">wsgi_server_name</span> <span class="o">=</span> <span class="n">get_host</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;wsgi.url_scheme&quot;</span><span class="p">]</span>
        <span class="n">upgrade</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;upgrade&quot;</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_CONNECTION&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">upgrade</span> <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_UPGRADE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;websocket&quot;</span><span class="p">:</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="s2">&quot;wss&quot;</span> <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span> <span class="k">else</span> <span class="s2">&quot;ws&quot;</span>

        <span class="k">if</span> <span class="n">server_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">server_name</span> <span class="o">=</span> <span class="n">wsgi_server_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">server_name</span> <span class="o">=</span> <span class="n">server_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="c1"># strip standard port to match get_host()</span>
            <span class="k">if</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;ws&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="n">server_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;:80&quot;</span><span class="p">):</span>
                <span class="n">server_name</span> <span class="o">=</span> <span class="n">server_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="n">server_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;:443&quot;</span><span class="p">):</span>
                <span class="n">server_name</span> <span class="o">=</span> <span class="n">server_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">subdomain</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_matching</span><span class="p">:</span>
            <span class="n">cur_server_name</span> <span class="o">=</span> <span class="n">wsgi_server_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">real_server_name</span> <span class="o">=</span> <span class="n">server_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">real_server_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cur_server_name</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">real_server_name</span><span class="p">:</span>
                <span class="c1"># This can happen even with valid configs if the server was</span>
                <span class="c1"># accessed directly by IP address under some situations.</span>
                <span class="c1"># Instead of raising an exception like in Werkzeug 0.7 or</span>
                <span class="c1"># earlier we go by an invalid subdomain which will result</span>
                <span class="c1"># in a 404 error on matching.</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Current server name </span><span class="si">{</span><span class="n">wsgi_server_name</span><span class="si">!r}</span><span class="s2"> doesn&#39;t match configured&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; server name </span><span class="si">{</span><span class="n">server_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">subdomain</span> <span class="o">=</span> <span class="s2">&quot;&lt;invalid&gt;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subdomain</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">cur_server_name</span><span class="p">[:</span><span class="n">offset</span><span class="p">]))</span>

        <span class="k">def</span> <span class="nf">_get_wsgi_string</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_wsgi_decoding_dance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">script_name</span> <span class="o">=</span> <span class="n">_get_wsgi_string</span><span class="p">(</span><span class="s2">&quot;SCRIPT_NAME&quot;</span><span class="p">)</span>
        <span class="n">path_info</span> <span class="o">=</span> <span class="n">_get_wsgi_string</span><span class="p">(</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">)</span>
        <span class="n">query_args</span> <span class="o">=</span> <span class="n">_get_wsgi_string</span><span class="p">(</span><span class="s2">&quot;QUERY_STRING&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Map</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">server_name</span><span class="p">,</span>
            <span class="n">script_name</span><span class="p">,</span>
            <span class="n">subdomain</span><span class="p">,</span>
            <span class="n">scheme</span><span class="p">,</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;REQUEST_METHOD&quot;</span><span class="p">],</span>
            <span class="n">path_info</span><span class="p">,</span>
            <span class="n">query_args</span><span class="o">=</span><span class="n">query_args</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called before matching and building to keep the compiled rules</span>
<span class="sd">        in the correct order after things changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_matcher</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">rules</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">rules</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">build_compare_key</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_rules</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">pformat</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rules</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="k">class</span> <span class="nc">MapAdapter</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returned by :meth:`Map.bind` or :meth:`Map.bind_to_environ` and does</span>
<span class="sd">    the URL matching and building based on runtime information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">map</span><span class="p">:</span> <span class="n">Map</span><span class="p">,</span>
        <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">script_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">subdomain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">url_scheme</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">path_info</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">server_name</span><span class="p">)</span>
        <span class="n">script_name</span> <span class="o">=</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">script_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">script_name</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">script_name</span> <span class="o">=</span> <span class="n">script_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span> <span class="o">=</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">subdomain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_scheme</span> <span class="o">=</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">url_scheme</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_info</span> <span class="o">=</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">path_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_method</span> <span class="o">=</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">default_method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_args</span> <span class="o">=</span> <span class="n">query_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_scheme</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;ws&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">view_func</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]],</span> <span class="s2">&quot;WSGIApplication&quot;</span><span class="p">],</span>
        <span class="n">path_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">catch_http_exceptions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;WSGIApplication&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Does the complete dispatching process.  `view_func` is called with</span>
<span class="sd">        the endpoint and a dict with the values for the view.  It should</span>
<span class="sd">        look up the view function, call it, and return a response object</span>
<span class="sd">        or WSGI application.  http exceptions are not caught by default</span>
<span class="sd">        so that applications can display nicer error messages by just</span>
<span class="sd">        catching them by hand.  If you want to stick with the default</span>
<span class="sd">        error messages you can pass it ``catch_http_exceptions=True`` and</span>
<span class="sd">        it will catch the http exceptions.</span>

<span class="sd">        Here a small example for the dispatch usage::</span>

<span class="sd">            from werkzeug.wrappers import Request, Response</span>
<span class="sd">            from werkzeug.wsgi import responder</span>
<span class="sd">            from werkzeug.routing import Map, Rule</span>

<span class="sd">            def on_index(request):</span>
<span class="sd">                return Response(&#39;Hello from the index&#39;)</span>

<span class="sd">            url_map = Map([Rule(&#39;/&#39;, endpoint=&#39;index&#39;)])</span>
<span class="sd">            views = {&#39;index&#39;: on_index}</span>

<span class="sd">            @responder</span>
<span class="sd">            def application(environ, start_response):</span>
<span class="sd">                request = Request(environ)</span>
<span class="sd">                urls = url_map.bind_to_environ(environ)</span>
<span class="sd">                return urls.dispatch(lambda e, v: views[e](request, **v),</span>
<span class="sd">                                     catch_http_exceptions=True)</span>

<span class="sd">        Keep in mind that this method might return exception objects, too, so</span>
<span class="sd">        use :class:`Response.force_type` to get a response object.</span>

<span class="sd">        :param view_func: a function that is called with the endpoint as</span>
<span class="sd">                          first argument and the value dict as second.  Has</span>
<span class="sd">                          to dispatch to the actual view function with this</span>
<span class="sd">                          information.  (see above)</span>
<span class="sd">        :param path_info: the path info to use for matching.  Overrides the</span>
<span class="sd">                          path info specified on binding.</span>
<span class="sd">        :param method: the HTTP method used for matching.  Overrides the</span>
<span class="sd">                       method specified on binding.</span>
<span class="sd">        :param catch_http_exceptions: set to `True` to catch any of the</span>
<span class="sd">                                      werkzeug :class:`HTTPException`\\s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">endpoint</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path_info</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RequestRedirect</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">e</span>
            <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">catch_http_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">e</span>
            <span class="k">raise</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_rule</span><span class="p">:</span> <span class="s2">&quot;te.Literal[False]&quot;</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">websocket</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="o">...</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_rule</span><span class="p">:</span> <span class="s2">&quot;te.Literal[True]&quot;</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">websocket</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Rule</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_rule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">websocket</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Rule</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The usage is simple: you just pass the match method the current</span>
<span class="sd">        path info as well as the method (which defaults to `GET`).  The</span>
<span class="sd">        following things can then happen:</span>

<span class="sd">        - you receive a `NotFound` exception that indicates that no URL is</span>
<span class="sd">          matching.  A `NotFound` exception is also a WSGI application you</span>
<span class="sd">          can call to get a default page not found page (happens to be the</span>
<span class="sd">          same object as `werkzeug.exceptions.NotFound`)</span>

<span class="sd">        - you receive a `MethodNotAllowed` exception that indicates that there</span>
<span class="sd">          is a match for this URL but not for the current request method.</span>
<span class="sd">          This is useful for RESTful applications.</span>

<span class="sd">        - you receive a `RequestRedirect` exception with a `new_url`</span>
<span class="sd">          attribute.  This exception is used to notify you about a request</span>
<span class="sd">          Werkzeug requests from your WSGI application.  This is for example the</span>
<span class="sd">          case if you request ``/foo`` although the correct URL is ``/foo/``</span>
<span class="sd">          You can use the `RequestRedirect` instance as response-like object</span>
<span class="sd">          similar to all other subclasses of `HTTPException`.</span>

<span class="sd">        - you receive a ``WebsocketMismatch`` exception if the only</span>
<span class="sd">          match is a WebSocket rule but the bind is an HTTP request, or</span>
<span class="sd">          if the match is an HTTP rule but the bind is a WebSocket</span>
<span class="sd">          request.</span>

<span class="sd">        - you get a tuple in the form ``(endpoint, arguments)`` if there is</span>
<span class="sd">          a match (unless `return_rule` is True, in which case you get a tuple</span>
<span class="sd">          in the form ``(rule, arguments)``)</span>

<span class="sd">        If the path info is not passed to the match method the default path</span>
<span class="sd">        info of the map is used (defaults to the root URL if not defined</span>
<span class="sd">        explicitly).</span>

<span class="sd">        All of the exceptions raised are subclasses of `HTTPException` so they</span>
<span class="sd">        can be used as WSGI responses. They will all render generic error or</span>
<span class="sd">        redirect pages.</span>

<span class="sd">        Here is a small example for matching:</span>

<span class="sd">        &gt;&gt;&gt; m = Map([</span>
<span class="sd">        ...     Rule(&#39;/&#39;, endpoint=&#39;index&#39;),</span>
<span class="sd">        ...     Rule(&#39;/downloads/&#39;, endpoint=&#39;downloads/index&#39;),</span>
<span class="sd">        ...     Rule(&#39;/downloads/&lt;int:id&gt;&#39;, endpoint=&#39;downloads/show&#39;)</span>
<span class="sd">        ... ])</span>
<span class="sd">        &gt;&gt;&gt; urls = m.bind(&quot;example.com&quot;, &quot;/&quot;)</span>
<span class="sd">        &gt;&gt;&gt; urls.match(&quot;/&quot;, &quot;GET&quot;)</span>
<span class="sd">        (&#39;index&#39;, {})</span>
<span class="sd">        &gt;&gt;&gt; urls.match(&quot;/downloads/42&quot;)</span>
<span class="sd">        (&#39;downloads/show&#39;, {&#39;id&#39;: 42})</span>

<span class="sd">        And here is what happens on redirect and missing URLs:</span>

<span class="sd">        &gt;&gt;&gt; urls.match(&quot;/downloads&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        RequestRedirect: http://example.com/downloads/</span>
<span class="sd">        &gt;&gt;&gt; urls.match(&quot;/missing&quot;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        NotFound: 404 Not Found</span>

<span class="sd">        :param path_info: the path info to use for matching.  Overrides the</span>
<span class="sd">                          path info specified on binding.</span>
<span class="sd">        :param method: the HTTP method used for matching.  Overrides the</span>
<span class="sd">                       method specified on binding.</span>
<span class="sd">        :param return_rule: return the rule that matched instead of just the</span>
<span class="sd">                            endpoint (defaults to `False`).</span>
<span class="sd">        :param query_args: optional query arguments that are used for</span>
<span class="sd">                           automatic redirects as string or dictionary.  It&#39;s</span>
<span class="sd">                           currently not possible to use the query arguments</span>
<span class="sd">                           for URL matching.</span>
<span class="sd">        :param websocket: Match WebSocket instead of HTTP requests. A</span>
<span class="sd">            websocket request has a ``ws`` or ``wss``</span>
<span class="sd">            :attr:`url_scheme`. This overrides that detection.</span>

<span class="sd">        .. versionadded:: 1.0</span>
<span class="sd">            Added ``websocket``.</span>

<span class="sd">        .. versionchanged:: 0.8</span>
<span class="sd">            ``query_args`` can be a string.</span>

<span class="sd">        .. versionadded:: 0.7</span>
<span class="sd">            Added ``query_args``.</span>

<span class="sd">        .. versionadded:: 0.6</span>
<span class="sd">            Added ``return_rule``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">path_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_info</span> <span class="o">=</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">path_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">method</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_method</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">websocket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">websocket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span>

        <span class="n">domain_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">host_matching</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span>
        <span class="n">path_part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">path_info</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">path_info</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">_matcher</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">domain_part</span><span class="p">,</span> <span class="n">path_part</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">websocket</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RequestPath</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RequestRedirect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_redirect_url</span><span class="p">(</span>
                    <span class="n">url_quote</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">path_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s2">&quot;/:|+&quot;</span><span class="p">),</span>
                    <span class="n">query_args</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">RequestAliasRedirect</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RequestRedirect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_alias_redirect_url</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain_part</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">path_part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">matched_values</span><span class="p">,</span>
                    <span class="n">method</span><span class="p">,</span>
                    <span class="n">query_args</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">NoMatch</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">have_match_for</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MethodNotAllowed</span><span class="p">(</span><span class="n">valid_methods</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">have_match_for</span><span class="p">))</span> <span class="kn">from</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">websocket_mismatch</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WebsocketMismatch</span><span class="p">()</span> <span class="kn">from</span> <span class="kc">None</span>

            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">()</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rule</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">result</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">redirect_defaults</span><span class="p">:</span>
                <span class="n">redirect_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_redirect</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">query_args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">redirect_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RequestRedirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">redirect_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

                    <span class="k">def</span> <span class="nf">_handle_match</span><span class="p">(</span><span class="n">match</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
                        <span class="k">return</span> <span class="n">rule</span><span class="o">.</span><span class="n">_converters</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">to_url</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">_simple_rule_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_handle_match</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">rv</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span><span class="p">:</span>
                    <span class="n">netloc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">netloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span>

                <span class="k">raise</span> <span class="n">RequestRedirect</span><span class="p">(</span>
                    <span class="n">url_join</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url_scheme</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;http&#39;</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">netloc</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">script_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">redirect_url</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">return_rule</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rule</span><span class="p">,</span> <span class="n">rv</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test if a rule would match.  Works like `match` but returns `True`</span>
<span class="sd">        if the URL matches, or `False` if it does not exist.</span>

<span class="sd">        :param path_info: the path info to use for matching.  Overrides the</span>
<span class="sd">                          path info specified on binding.</span>
<span class="sd">        :param method: the HTTP method used for matching.  Overrides the</span>
<span class="sd">                       method specified on binding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path_info</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RequestRedirect</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">allowed_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the valid methods that match for a given path.</span>

<span class="sd">        .. versionadded:: 0.7</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path_info</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MethodNotAllowed</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">valid_methods</span>  <span class="c1"># type: ignore</span>
        <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">get_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain_part</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Figures out the full host name for the given domain part.  The</span>
<span class="sd">        domain part is a subdomain in case host matching is disabled or</span>
<span class="sd">        a full host name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">host_matching</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">domain_part</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span>
            <span class="k">return</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">domain_part</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">subdomain</span> <span class="o">=</span> <span class="n">domain_part</span>
        <span class="k">if</span> <span class="n">subdomain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subdomain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subdomain</span> <span class="o">=</span> <span class="n">_to_str</span><span class="p">(</span><span class="n">subdomain</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subdomain</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subdomain</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span>

    <span class="k">def</span> <span class="nf">get_default_redirect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rule</span><span class="p">:</span> <span class="n">Rule</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A helper that returns the URL to redirect to if it finds one.</span>
<span class="sd">        This is used for default redirecting only.</span>

<span class="sd">        :internal:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">redirect_defaults</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">]:</span>
            <span class="c1"># every rule that comes after this one, including ourself</span>
            <span class="c1"># has a lower priority for the defaults.  We order the ones</span>
            <span class="c1"># with the highest priority up for building.</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="n">rule</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">provides_defaults_for</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">suitable_for</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
                <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="n">domain_part</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_redirect_url</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">query_args</span><span class="p">,</span> <span class="n">domain_part</span><span class="o">=</span><span class="n">domain_part</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">encode_query_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">url_encode</span><span class="p">(</span><span class="n">query_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query_args</span>

    <span class="k">def</span> <span class="nf">make_redirect_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_info</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">domain_part</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a redirect URL.</span>

<span class="sd">        :internal:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">query_args</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;?</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">encode_query_args</span><span class="p">(</span><span class="n">query_args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_scheme</span> <span class="ow">or</span> <span class="s2">&quot;http&quot;</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_host</span><span class="p">(</span><span class="n">domain_part</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="n">path_info</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">make_alias_redirect_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internally called to make an alias redirect URL.&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">append_unknown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_external</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">query_args</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;?</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">encode_query_args</span><span class="p">(</span><span class="n">query_args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="n">url</span> <span class="o">!=</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;detected invalid alias setting. No canonical URL found&quot;</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">_partial_build</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">append_unknown</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper for :meth:`build`.  Returns subdomain and path for the</span>
<span class="sd">        rule that accepts this endpoint, values and method.</span>

<span class="sd">        :internal:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># in case the method is none, try with the default method first</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_build</span><span class="p">(</span>
                <span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_method</span><span class="p">,</span> <span class="n">append_unknown</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rv</span>

        <span class="c1"># Default method did not match or a specific method is passed.</span>
        <span class="c1"># Check all for first match with matching host. If no matching</span>
        <span class="c1"># host is found, go with first result.</span>
        <span class="n">first_match</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="p">()):</span>
            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">suitable_for</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
                <span class="n">build_rv</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">append_unknown</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">build_rv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="p">(</span><span class="n">build_rv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">build_rv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rule</span><span class="o">.</span><span class="n">websocket</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">host_matching</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">rv</span>
                        <span class="k">elif</span> <span class="n">first_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">first_match</span> <span class="o">=</span> <span class="n">rv</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">rv</span>

        <span class="k">return</span> <span class="n">first_match</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force_external</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">append_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">url_scheme</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Building URLs works pretty much the other way round.  Instead of</span>
<span class="sd">        `match` you call `build` and pass it the endpoint and a dict of</span>
<span class="sd">        arguments for the placeholders.</span>

<span class="sd">        The `build` function also accepts an argument called `force_external`</span>
<span class="sd">        which, if you set it to `True` will force external URLs. Per default</span>
<span class="sd">        external URLs (include the server name) will only be used if the</span>
<span class="sd">        target URL is on a different subdomain.</span>

<span class="sd">        &gt;&gt;&gt; m = Map([</span>
<span class="sd">        ...     Rule(&#39;/&#39;, endpoint=&#39;index&#39;),</span>
<span class="sd">        ...     Rule(&#39;/downloads/&#39;, endpoint=&#39;downloads/index&#39;),</span>
<span class="sd">        ...     Rule(&#39;/downloads/&lt;int:id&gt;&#39;, endpoint=&#39;downloads/show&#39;)</span>
<span class="sd">        ... ])</span>
<span class="sd">        &gt;&gt;&gt; urls = m.bind(&quot;example.com&quot;, &quot;/&quot;)</span>
<span class="sd">        &gt;&gt;&gt; urls.build(&quot;index&quot;, {})</span>
<span class="sd">        &#39;/&#39;</span>
<span class="sd">        &gt;&gt;&gt; urls.build(&quot;downloads/show&quot;, {&#39;id&#39;: 42})</span>
<span class="sd">        &#39;/downloads/42&#39;</span>
<span class="sd">        &gt;&gt;&gt; urls.build(&quot;downloads/show&quot;, {&#39;id&#39;: 42}, force_external=True)</span>
<span class="sd">        &#39;http://example.com/downloads/42&#39;</span>

<span class="sd">        Because URLs cannot contain non ASCII data you will always get</span>
<span class="sd">        bytes back.  Non ASCII characters are urlencoded with the</span>
<span class="sd">        charset defined on the map instance.</span>

<span class="sd">        Additional values are converted to strings and appended to the URL as</span>
<span class="sd">        URL querystring parameters:</span>

<span class="sd">        &gt;&gt;&gt; urls.build(&quot;index&quot;, {&#39;q&#39;: &#39;My Searchstring&#39;})</span>
<span class="sd">        &#39;/?q=My+Searchstring&#39;</span>

<span class="sd">        When processing those additional values, lists are furthermore</span>
<span class="sd">        interpreted as multiple values (as per</span>
<span class="sd">        :py:class:`werkzeug.datastructures.MultiDict`):</span>

<span class="sd">        &gt;&gt;&gt; urls.build(&quot;index&quot;, {&#39;q&#39;: [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]})</span>
<span class="sd">        &#39;/?q=a&amp;q=b&amp;q=c&#39;</span>

<span class="sd">        Passing a ``MultiDict`` will also add multiple values:</span>

<span class="sd">        &gt;&gt;&gt; urls.build(&quot;index&quot;, MultiDict(((&#39;p&#39;, &#39;z&#39;), (&#39;q&#39;, &#39;a&#39;), (&#39;q&#39;, &#39;b&#39;))))</span>
<span class="sd">        &#39;/?p=z&amp;q=a&amp;q=b&#39;</span>

<span class="sd">        If a rule does not exist when building a `BuildError` exception is</span>
<span class="sd">        raised.</span>

<span class="sd">        The build method accepts an argument called `method` which allows you</span>
<span class="sd">        to specify the method you want to have an URL built for if you have</span>
<span class="sd">        different methods for the same endpoint specified.</span>

<span class="sd">        :param endpoint: the endpoint of the URL to build.</span>
<span class="sd">        :param values: the values for the URL to build.  Unhandled values are</span>
<span class="sd">                       appended to the URL as query parameters.</span>
<span class="sd">        :param method: the HTTP method for the rule if there are different</span>
<span class="sd">                       URLs for different methods on the same endpoint.</span>
<span class="sd">        :param force_external: enforce full canonical external URLs. If the URL</span>
<span class="sd">                               scheme is not provided, this will generate</span>
<span class="sd">                               a protocol-relative URL.</span>
<span class="sd">        :param append_unknown: unknown parameters are appended to the generated</span>
<span class="sd">                               URL as query string argument.  Disable this</span>
<span class="sd">                               if you want the builder to ignore those.</span>
<span class="sd">        :param url_scheme: Scheme to use in place of the bound</span>
<span class="sd">            :attr:`url_scheme`.</span>

<span class="sd">        .. versionchanged:: 2.0</span>
<span class="sd">            Added the ``url_scheme`` parameter.</span>

<span class="sd">        .. versionadded:: 0.6</span>
<span class="sd">           Added the ``append_unknown`` parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">MultiDict</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># plain dict</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_build</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">append_unknown</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BuildError</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">domain_part</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">websocket</span> <span class="o">=</span> <span class="n">rv</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_host</span><span class="p">(</span><span class="n">domain_part</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">url_scheme</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url_scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_scheme</span>

        <span class="c1"># Always build WebSocket routes with the scheme (browsers</span>
        <span class="c1"># require full URLs). If bound to a WebSocket, ensure that HTTP</span>
        <span class="c1"># routes are built with an HTTP scheme.</span>
        <span class="n">secure</span> <span class="o">=</span> <span class="n">url_scheme</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">websocket</span><span class="p">:</span>
            <span class="n">force_external</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">url_scheme</span> <span class="o">=</span> <span class="s2">&quot;wss&quot;</span> <span class="k">if</span> <span class="n">secure</span> <span class="k">else</span> <span class="s2">&quot;ws&quot;</span>
        <span class="k">elif</span> <span class="n">url_scheme</span><span class="p">:</span>
            <span class="n">url_scheme</span> <span class="o">=</span> <span class="s2">&quot;https&quot;</span> <span class="k">if</span> <span class="n">secure</span> <span class="k">else</span> <span class="s2">&quot;http&quot;</span>

        <span class="c1"># shortcut this.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_external</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">host_matching</span> <span class="ow">and</span> <span class="n">host</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">host_matching</span> <span class="ow">and</span> <span class="n">domain_part</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">script_name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">scheme</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url_scheme</span><span class="si">}</span><span class="s2">:&quot;</span> <span class="k">if</span> <span class="n">url_scheme</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scheme</span><span class="si">}</span><span class="s2">//</span><span class="si">{</span><span class="n">host</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">script_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">RaceMaster</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Piotr Jaocha & Mateusz Kotula.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>